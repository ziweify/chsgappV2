<template>
  <view class="layout">
    <view class="flex-layout">
      <TsCustom :backUrl="backUrl" :isBack="true" title="é€šçŸ¥é“ƒå£°"></TsCustom>
      <view class="flex-content">
        <view class="flex-list">
          <u-cell-group>
            <u-cell :stop="false" title="æ˜¯å¦å¼€å¯å¼¹çª—">
              <u-switch :activeValue="1" :inactiveValue="0" v-model="isReciveMsg" @change="switchChange($event)" :enableText="true" size="26" slot="value" activeColor="#0087B4FF" inactiveColor="#ccc"></u-switch>
            </u-cell>
            <u-cell title="ç§èŠ" :value="chatSound.label" :isLink="true" @click="showSound(1)"></u-cell>
            <u-cell title="ä¸Šåˆ†ç”³è¯·" :value="upSound.label" :isLink="true" @click="showSound(2)"></u-cell>
            <u-cell title="ä¸‹åˆ†ç”³è¯·" :value="downSound.label" :isLink="true" @click="showSound(3)"></u-cell>
            <u-cell title="å…¥ç¾¤ç”³è¯·" :value="joinSound.label" :isLink="true" @click="showSound(4)"></u-cell>
          </u-cell-group>
        </view>
      </view>
    </view>
    <u-picker :defaultIndex="defaultIndex" @confirm="confirm" confirmColor="#0087b4" :show="show" :columns="sounds" :closeOnClickOverlay="true" @close="show = false" @cancel="show = false" keyName="label" @change="soundChange"></u-picker>
  </view>
</template>

<script>

export default {
  mixins: [uni.$mymixin],
  data() {
    return {
      audio:null,
      volume:1,
      backUrl:'agent/roomset/roomset', // é»˜è®¤è¿”å›åœ°å€
      show:false,
      sounds:[],
      sounds1:[],
      sounds2:[],
      sounds3:[],
      sounds4:[],
      chatSound:{},
      upSound:{},
      downSound:{},
      joinSound:{},
      type:1,//1ç§èŠï¼Œ2ä¸Šåˆ†ç”³è¯·ï¼Œ3ä¸‹åˆ†ç”³è¯·ï¼Œ4å…¥ç¾¤ç”³è¯·
      defaultIndex:[1],
      isReciveMsg:1
    };
  },
  onLoad(options) {
    // å¦‚æœURLä¸­æœ‰returnUrlå‚æ•°ï¼Œä½¿ç”¨å®ƒä½œä¸ºè¿”å›åœ°å€
    if (options && options.returnUrl) {
      this.backUrl = decodeURIComponent(options.returnUrl);
      console.log('ğŸ”Š é€šçŸ¥é“ƒå£°é¡µé¢æ¥æ”¶åˆ°è¿”å›åœ°å€:', this.backUrl);
    }
    
    let isReciveMsg = uni.getStorageSync('isReciveMsg');
    if(parseInt(isReciveMsg)  == 0){
      this.isReciveMsg = 0;
    }
    //åˆå§‹åŒ–æŸ¥è¯¢æœ¬åœ°å£°éŸ³
    let chatSound = uni.getStorageSync('chatSound');
    if(chatSound){
      this.chatSound = JSON.parse(chatSound);
    }else{
      this.chatSound = {label:'é»˜è®¤',id:1};
    }
    let upSound = uni.getStorageSync('upSound');
    if(upSound){
      this.upSound = JSON.parse(upSound);
    }else{
      this.upSound = {label:'é»˜è®¤',id:13};
    }
    let downSound = uni.getStorageSync('downSound');
    if(downSound){
      this.downSound = JSON.parse(downSound);
    }else{
      this.downSound = {label:'é»˜è®¤',id:13};
    }
    let joinSound = uni.getStorageSync('joinSound');
    if(joinSound){
      this.joinSound = JSON.parse(joinSound);
    }else{
      this.joinSound = {label:'é»˜è®¤',id:2};
    }

    let volume = uni.getStorageSync('volume');
    if(volume){
      this.volume = volume;
    }
    this.audio = uni.createInnerAudioContext();
    this.audio.volume = this.volume;

    //åˆå§‹åŒ–ç§èŠ
    this.sounds1 = [{label:'æ— ',id:0},{label:'é»˜è®¤',id:1}];
    this.sounds2 = [{label:'æ— ',id:0},{label:'é»˜è®¤',id:13}];
    this.sounds3 = [{label:'æ— ',id:0},{label:'é»˜è®¤',id:13}];
    this.sounds4 = [{label:'æ— ',id:0},{label:'é»˜è®¤',id:2}];
    for(let i=2;i<=14;i++){//å¾ªç¯1-14
      this.sounds1.push({label:'æç¤ºéŸ³'+(i-1),id:i});
      this.sounds2.push({label:'æç¤ºéŸ³'+(i-1),id:i});
      this.sounds3.push({label:'æç¤ºéŸ³'+(i-1),id:i});
      this.sounds4.push({label:'æç¤ºéŸ³'+(i-1),id:i});
    }
    this.sounds2.push({label:'æç¤ºéŸ³15',id:15});
    this.sounds3.push({label:'æç¤ºéŸ³15',id:16});
    this.sounds4.push({label:'æç¤ºéŸ³15',id:17});
  },
  mounted() {

  },
  methods: {
    switchChange(e){
      uni.setStorageSync('isReciveMsg',e);
    },
    confirm(e){
      this.show = false;
      let json = e.value[0];
      if(this.type === 1){//ç§èŠ
        uni.setStorageSync('chatSound',JSON.stringify(json));
        this.chatSound = json;
      }else if(this.type === 2){//ä¸Šåˆ†ç”³è¯·
        uni.setStorageSync('upSound',JSON.stringify(json));
        this.upSound = json;
      }else if(this.type === 3){//ä¸‹åˆ†ç”³è¯·
        uni.setStorageSync('downSound',JSON.stringify(json));
        this.downSound = json;
      }else if(this.type === 4) {//å…¥ç¾¤ç”³è¯·
        uni.setStorageSync('joinSound', JSON.stringify(json));
        this.joinSound = json;
      }
      this.$u.toast('è®¾ç½®æˆåŠŸ');
    },
    soundChange(e){
      let id = e.value[0].id;
      this.audio.src = "/static/wav/s"+id+".mp3";
      this.audio.play();
    },
    showSound(type){
      this.type = type;
      this.sounds = [this['sounds'+type]];
      let temparr = this.sounds[0];
      //å¾ªç¯æ‰¾é»˜è®¤å€¼
      for(let i=0;i<temparr.length;i++){
        if(type === 1){
          if(temparr[i].id === this.chatSound.id){
            this.defaultIndex = [i];
            break;
          }
        }else if(type === 2){
          if(temparr[i].id === this.upSound.id){
            this.defaultIndex = [i];
            break;
          }
        }else if(type === 3){
          if(temparr[i].id === this.downSound.id){
            this.defaultIndex = [i];
            break;
          }
        }else if(type === 4){
          if(temparr[i].id === this.joinSound.id){
            this.defaultIndex = [i];
            break;
          }
        }
      }
      this.show = true;
    }
  }
}
</script>

<style lang="scss" scoped>

</style>
