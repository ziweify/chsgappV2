<template>
  <view class="layout">
    <view class="flex-layout">
      <TsCustom :backUrl="backUrl" :isBack="true" title="æ¸¸æˆè®¾ç½®">
        <block slot='right'>
          <view @click="saveGameSetting" class="header-refresh-no">ä¿å­˜</view>
        </block>
      </TsCustom>
      <view class="flex-content">
        <u-collapse>
          <u-collapse-item :clickable="false" :is-link="false" v-for="(item,index) in gameList" :title="item.gname" :key="index">
            <view slot="icon">
              <image style="width: 60rpx;height: 60rpx;margin-right: 10rpx;" :src="'/static/glogo1/'+item.gid+'.png'"></image>
            </view>
            <view slot="value" style="margin-right: 10rpx;" @tap.stop.prevent>
              <u-switch @change="doWwitch($event,item)" :activeValue="1" :inactiveValue="0" size="18" activeColor="#0087B4FF" inactiveColor="#ccc" v-model="item.ifok"></u-switch>
            </view>
            <view class="content">
              <u--form labelWidth="140" labelPosition="left" ref="uForm">
                <u-form-item label="åºå·ï¼š" prop="userInfo.name" borderBottom>
                  <u--input v-model="item.xsort" border="none"></u--input>
                </u-form-item>
                <u-form-item label="æå‰å°ç›˜æ—¶é—´/ç§’ï¼š" prop="userInfo.name" borderBottom>
                  <u--input v-model="item.fpseconds" border="none"></u--input>
                  <view @click="doBetch('fpseconds',index)" class="piliang">æ‰¹é‡</view>
                </u-form-item>
                <!-- <u-form-item label="è‡ªåŠ¨å¼€å§‹ï¼š" prop="userInfo.name" borderBottom>
                  <view style="display: flex;width: 100%;">
                    <view style="display: flex;flex: 1;align-items: center" @click="showPicker(index,'autoStartTime')">
                      <u-icon size="18" color="#ddd" name="clock"></u-icon>
                      <view style="margin-left: 20rpx;font-size: 28rpx;">
                        <text style="color: rgb(171 167 167);" v-if="!item.autoStartTime">è‡ªåŠ¨å¼€å§‹æ—¶é—´</text>
                        <text v-if="item.autoStartTime">{{item.autoStartTime}}</text>
                      </view>
                    </view>
                    <view v-if="item.autoStartTime" style="display: flex;justify-content: flex-end;margin-right: 40rpx;">
                      <u-icon @click="clearStartTime(index)" size="16" color="#878a91" name="close-circle-fill"></u-icon>
                    </view>
                    <view @click="doBetch('autoStartTime',index)" class="piliang">æ‰¹é‡</view>
                  </view>
                </u-form-item>
                <u-form-item label="è‡ªåŠ¨ç»“æŸï¼š" prop="userInfo.name" borderBottom>
                  <view style="display: flex;width: 100%;">
                    <view style="display: flex;flex: 1;align-items: center" @click="showPicker(index,'autoEndTime')">
                      <u-icon size="18" color="#ddd" name="clock"></u-icon>
                      <view style="margin-left: 20rpx;font-size: 28rpx;">
                        <text style="color: rgb(171 167 167);" v-if="!item.autoEndTime">è‡ªåŠ¨ç»“æŸæ—¶é—´</text>
                        <text v-if="item.autoEndTime">{{item.autoEndTime}}</text>
                      </view>
                    </view>
                    <view v-if="item.autoEndTime" style="display: flex;justify-content: flex-end;margin-right: 40rpx;">
                      <u-icon @click="clearEndTime(index)" size="16" color="#878a91" name="close-circle-fill"></u-icon>
                    </view>
                    <view @click="doBetch('autoEndTime',index)" class="piliang">æ‰¹é‡</view>
                  </view>
                </u-form-item> -->
                <u-form-item  label="" prop="userInfo.name" borderBottom>
                  <view style="display: flex;justify-content: flex-start;width: 160px;align-items: center">
                    <u-icon @click="tips()" size="22" color="rgb(0, 135, 180)" name="error-circle"></u-icon>
                    <view style="margin-left: 20rpx;">æ˜¯å¦å…è®¸å–æ¶ˆæ³¨å•</view>
                  </view>
                  <view style="display: flex;justify-content: flex-end;flex: 1;margin-right: 40rpx;">
                    <u-switch :activeValue="1" :inactiveValue="0" size="16" activeColor="#0087B4FF" inactiveColor="#ccc" v-model="item.isCancelOrder"></u-switch>
                  </view>
                  <view @click="doBetch('isCancelOrder',index)" class="piliang">æ‰¹é‡</view>
                </u-form-item>
                <view style="font-size: 24rpx;padding:20rpx 0;color: #8f8d8e">
                  æ³¨æ„ï¼šæå‰å°ç›˜æ—¶é—´è¯·å‚è€ƒç›˜å†…å°ç›˜æ—¶é—´è®¾ç½®ï¼Œæœ€ä¼˜é€‰æ‹©æ˜¯æ¯”ç›˜å†…æå‰å°ç›˜ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´é£å•å¤±è´¥ã€‚
                </view>
              </u--form>
            </view>
          </u-collapse-item>
        </u-collapse>
      </view>
      <view class="footer">
        <view class="footer-item" @click="switchGame(2,0,0)"  style="background: linear-gradient(270deg, rgb(106, 116, 117), #a2b6bd);">ä¸€é”®å…³é—­</view>
        <view class="footer-item" @click="switchGame(3,0,0)">ä¸€é”®å¼€å¯</view>
      </view>
    </view>
    <u-picker :show="show" ref="uPicker" :closeOnClickOverlay="true" @close="show = false" @cancel="show=false" :columns="columns" @confirm="confirm" @change="changeHandler"></u-picker>
    <u-popup :customStyle="{'width':'90%'}" :show="tipsShow" mode="center" :round="5" @close="tipsShow = false" :closeOnClickOverlay="true">
      <view style="padding: 10px;display: flex;flex-direction: column;justify-content: center">
        <text style="margin-bottom: 5px;color: #f56c6c">æç¤ºï¼š</text>
        <view style="display: flex;justify-content: center;flex-direction: column;">
          <text style="line-height: 20px;color: #423f44">å–æ¶ˆæ³¨å•éœ€æ»¡è¶³ä¸‰ä¸ªæ¡ä»¶ï¼š</text>
          <text style="line-height: 20px;color: #423f44">â‘ æ¸¸æˆæœªå°ç›˜</text>
          <text style="line-height: 20px;color: #423f44">â‘¡æ¸¸æˆè®¾ç½®ä¸­å¼€å¯å…è®¸å–æ¶ˆæ³¨å•</text>
          <text style="line-height: 20px;color: #423f44">â‘¢æ‰“ç›˜æŠ¥è¡¨ä¸­è®¾ç½®é£å•æ¨¡å¼ä¸ºï¼šè·ç¦»å°ç›˜Nç§’é£ï¼Œä¸”æ¸¸æˆå€’è®¡æ—¶å¤§äºNç§’</text>
        </view>
      </view>
    </u-popup>
  </view>
</template>

<script>
export default {
  mixins: [uni.$mymixin],
  data() {
    return {
      backUrl: 'agent/roomset/roomset', // é»˜è®¤è¿”å›åœ°å€
      checked: true,
      gameList: [],
      tipsShow: false,
      show:false,
      columns:[[],[]],
      columnData:[],
      currentIndex:0,
      field:''
    }
  },
  onLoad(options) {
    // å¦‚æœURLä¸­æœ‰returnUrlå‚æ•°ï¼Œä½¿ç”¨å®ƒä½œä¸ºè¿”å›åœ°å€
    if (options && options.returnUrl) {
      this.backUrl = decodeURIComponent(options.returnUrl);
      console.log('ğŸ® æ¸¸æˆè®¾ç½®é¡µé¢æ¥æ”¶åˆ°è¿”å›åœ°å€:', this.backUrl);
    }
    
    //ç”Ÿæˆåˆ—æ—¶é—´ï¼Œ0-23ç‚¹
    for(let i=0;i<24;i++){
      if(i < 10){
        this.columns[0].push('0'+i);
      }else{
        this.columns[0].push(i+'');
      }
      //ç”Ÿæˆåˆ—åˆ†é’Ÿï¼Œ0-59åˆ†
      this.columnData[i] = [];
      for(let x=0;x<60;x++){
        if (x < 10){
          this.columnData[i].push('0'+x);
        }else{
          this.columnData[i].push(x+'');
        }
      }
    }
    this.columns[1] = this.columnData[0];
  },
  onReady() {
    this.getGameSettingList();
  },
  methods: {
    saveGameSetting(){
      uni.showLoading({title: 'åŠ è½½ä¸­'});
      this.$u.api.agent.saveGameSetting({gameList:this.gameList}).then(res => {
        uni.hideLoading();
        this.$u.toast(res.msg);
      });
    },
    doBetch(field,index){
      //å¾ªç¯æ‰¹é‡è®¾ç½®
      for(let i=0;i<this.gameList.length;i++){
        if(i === index){
          continue;
        }
        this.gameList[i][field] = this.gameList[index][field];
      }
      this.$u.toast("å·²æ‰¹é‡ä¿®æ”¹");
    },
    clearStartTime(index){
      this.gameList[index].autoStartTime = '';
    },
    clearEndTime(index){
      this.gameList[index].autoEndTime = '';
    },
    confirm(e){
      const time = e.value[0]+":"+e.value[1];
      this.gameList[this.currentIndex][this.field] = time;
      this.show = false;
    },
    changeHandler(e){
      const {columnIndex,index,picker = this.$refs.uPicker} = e;
      if (columnIndex === 0) {
        picker.setColumnValues(1, this.columnData[index])
      }
    },
    showPicker(index,field){
      this.currentIndex = index;
      this.field = field;
      this.show = true;
    },
    tips(){
      this.tipsShow = true;
    },
    doWwitch(value,item){
      this.switchGame(1,item.gid,value);
    },
    getGameSettingList(){
      this.$u.api.agent.getGameSettingList({}).then(res => {
        this.gameList = res.data.gameList;
      });
    },
    switchGame(type,gid,status){
      this.$u.api.agent.switchGame({type,gid,status}).then(res => {
        if(type == 2 || type == 3){
          this.getGameSettingList();
        }
        this.$u.toast(res.msg);
      });
    },
  }
}
</script>
<style lang="scss" scoped>

.piliang{
  border: 4rpx solid #dadbde;
  padding: 2rpx 18rpx;
  font-size: 24rpx;
  border-radius: 6px;
  margin-right: 20rpx;
  color: rgb(171, 167, 167);
}

.footer{
  display: flex;
  width: 100%;
  background: #f3f7f9;
  justify-content: space-around;
  padding: 40rpx 0;
  &-item{
    color: #fff;
    background: linear-gradient(270deg, #08bbc2, #144988);
    border-radius: 40rpx;
    padding: 20rpx 100rpx;
    text-align: center;
    font-size: 30rpx;
  }
}

.content{
  background-color: #f3f7f9;
  padding-left:20rpx;
}

.layout{
  width: 100%;
  height: 100%;
  overflow: hidden;
  .flex-layout{
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow: hidden;
    .flex-content {
      width: 100%;
      height: 100%;
      flex: 1;
      overflow-y: auto;
      scroll-behavior: smooth;
    }
  }
}

.header-refresh-no {
  display: flex;
  align-items: center;
  color: #fff;
  font-weight: 500;
  font-size: 30rpx;
  justify-content: flex-end;
  margin-right: 15rpx;
  height: 100%;
}
</style>
