# ğŸš€ å¾®ä¿¡åå°æ¢å¤é—®é¢˜ä¿®å¤ - å¿«é€Ÿå¼€å§‹

## âš¡ 5 åˆ†é’Ÿå¿«é€Ÿæµ‹è¯•

### æ­¥éª¤ 1: æµ‹è¯•ç‹¬ç«‹é¡µé¢ï¼ˆä¸éœ€è¦ç¼–è¯‘ï¼‰

1. åœ¨å¾®ä¿¡ä¸­æ‰“å¼€æµ‹è¯•é¡µé¢ï¼š
   ```
   https://ä½ çš„åŸŸå/æµ‹è¯•é¡µé¢å¯è§æ€§ä¿®å¤.html
   ```

2. è§‚å¯Ÿé¡µé¢ä¸Šçš„è®¡æ—¶å™¨æ­£å¸¸è¿è¡Œ

3. åˆ‡æ¢åˆ°å¾®ä¿¡èŠå¤©ï¼Œç­‰å¾… 10-30 ç§’

4. åˆ‡æ¢å›æµ‹è¯•é¡µé¢

5. âœ… **éªŒè¯**: è®¡æ—¶å™¨åº”è¯¥ç»§ç»­è¿è¡Œï¼Œé¡µé¢æ˜¾ç¤º"é¡µé¢æ¢å¤å¯è§"æ—¥å¿—

**é¢„æœŸç»“æœ**: 
- è®¡æ—¶å™¨ä¸ä¸­æ–­
- æ—¥å¿—æ˜¾ç¤ºéšè—æ—¶é•¿
- ç¯å¢ƒæ£€æµ‹æ˜¾ç¤ºç»¿è‰²âœ…

---

### æ­¥éª¤ 2: é›†æˆåˆ°ç°æœ‰åº”ç”¨

#### æ–¹æ¡ˆ A: å…¨å±€ç”Ÿæ•ˆï¼ˆå·²å®Œæˆï¼Œæ— éœ€é¢å¤–æ“ä½œï¼‰

ä¿®å¤å·²ç»åœ¨ä»¥ä¸‹æ–‡ä»¶ä¸­å…¨å±€ç”Ÿæ•ˆï¼š
- âœ… `main.js` - åˆå§‹åŒ–å¯è§æ€§ç®¡ç†å™¨
- âœ… `App.vue` - å…¨å±€æ¢å¤å¤„ç†
- âœ… `common/websocketUtils.js` - WebSocket è‡ªåŠ¨é‡è¿

**ä¸éœ€è¦ä¿®æ”¹ä»»ä½•é¡µé¢ä»£ç ï¼**

#### æ–¹æ¡ˆ B: é¡µé¢çº§ç²¾ç¡®æ§åˆ¶ï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦åœ¨ç‰¹å®šé¡µé¢ä¸­æ·»åŠ è‡ªå®šä¹‰æ¢å¤é€»è¾‘ï¼š

```javascript
// åœ¨ä»»ä½•é¡µé¢çš„ onLoad ä¸­æ·»åŠ ï¼š
onLoad() {
  // #ifdef H5
  this.visibilityUnsubscribe = uni.$visibilityManager.addListener('visible', (data) => {
    console.log('é¡µé¢æ¢å¤ï¼Œéšè—äº†', data.hiddenDuration / 1000, 'ç§’');
    
    // è‡ªå®šä¹‰æ¢å¤é€»è¾‘
    this.refreshData();
    if (!this.timer) this.startTimer();
  });
  // #endif
}

// åœ¨ onUnload ä¸­æ¸…ç†ï¼š
onUnload() {
  if (this.visibilityUnsubscribe) {
    this.visibilityUnsubscribe();
  }
}
```

---

### æ­¥éª¤ 3: éªŒè¯ä¿®å¤æ•ˆæœ

#### åœ¨æµè§ˆå™¨æ§åˆ¶å°è¿è¡Œï¼š

```javascript
// 1. æ£€æŸ¥å¯è§æ€§ç®¡ç†å™¨æ˜¯å¦å·²åˆå§‹åŒ–
console.log('âœ… å¯è§æ€§ç®¡ç†å™¨:', uni.$visibilityManager ? 'å·²åˆå§‹åŒ–' : 'âŒ æœªåˆå§‹åŒ–');

// 2. æ£€æŸ¥å½“å‰é¡µé¢çŠ¶æ€
console.log('ğŸ“± é¡µé¢æ˜¯å¦å¯è§:', uni.$visibilityManager.isVisible());

// 3. æ£€æŸ¥ç›‘å¬å™¨æ•°é‡
console.log('ğŸ‘‚ ç›‘å¬å™¨æ•°é‡:', uni.$visibilityManager.listeners.length);

// 4. æ£€æŸ¥ WebSocket çŠ¶æ€
console.log('ğŸ”Œ WebSocket è¿æ¥:', uni.$socketUtils.isOpenSocket ? 'å·²è¿æ¥' : 'æœªè¿æ¥');

// 5. æ‰‹åŠ¨è§¦å‘æ¢å¤æµ‹è¯•
uni.$visibilityManager.manualRefresh();
```

**é¢„æœŸè¾“å‡ºï¼š**
```
âœ… å¯è§æ€§ç®¡ç†å™¨: å·²åˆå§‹åŒ–
ğŸ“± é¡µé¢æ˜¯å¦å¯è§: true
ğŸ‘‚ ç›‘å¬å™¨æ•°é‡: 2
ğŸ”Œ WebSocket è¿æ¥: å·²è¿æ¥
```

---

## ğŸ§ª å®Œæ•´æµ‹è¯•æµç¨‹

### æµ‹è¯• 1: åŸºç¡€æ¢å¤æµ‹è¯•

1. åœ¨å¾®ä¿¡ä¸­æ‰“å¼€åº”ç”¨
2. è¿›å…¥èŠå¤©å®¤é¡µé¢
3. è§‚å¯Ÿå€’è®¡æ—¶æ­£å¸¸è¿è¡Œï¼ˆä¾‹å¦‚ï¼š180 â†’ 179 â†’ 178...ï¼‰
4. åˆ‡æ¢åˆ°å¾®ä¿¡èŠå¤©
5. ç­‰å¾… 10 ç§’
6. åˆ‡æ¢å›åº”ç”¨
7. âœ… **éªŒè¯**: å€’è®¡æ—¶åº”è¯¥ç»§ç»­è¿è¡Œï¼ˆä¾‹å¦‚ï¼š170 â†’ 169...ï¼‰

### æµ‹è¯• 2: é•¿æ—¶é—´åå°æµ‹è¯•

1. åœ¨å¾®ä¿¡ä¸­æ‰“å¼€åº”ç”¨
2. åˆ‡æ¢åˆ°å¾®ä¿¡èŠå¤©
3. ç­‰å¾… 1-2 åˆ†é’Ÿ
4. åˆ‡æ¢å›åº”ç”¨
5. âœ… **éªŒè¯**: 
   - æ•°æ®æ›´æ–°åˆ°æœ€æ–°
   - å€’è®¡æ—¶æ­£å¸¸
   - ä½™é¢æ˜¾ç¤ºæ­£ç¡®

### æµ‹è¯• 3: å¿«é€Ÿåˆ‡æ¢æµ‹è¯•

1. åœ¨å¾®ä¿¡ä¸­æ‰“å¼€åº”ç”¨
2. å¿«é€Ÿåˆ‡æ¢å¾®ä¿¡èŠå¤©å’Œåº”ç”¨ 5-10 æ¬¡
3. âœ… **éªŒè¯**:
   - æ¯æ¬¡éƒ½èƒ½æ­£å¸¸æ¢å¤
   - æ²¡æœ‰å¡é¡¿
   - æ§åˆ¶å°æ— é”™è¯¯

### æµ‹è¯• 4: WebSocket é‡è¿æµ‹è¯•

1. åœ¨å¾®ä¿¡ä¸­æ‰“å¼€åº”ç”¨
2. è§‚å¯Ÿ WebSocket å·²è¿æ¥
3. åˆ‡æ¢åˆ°å¾®ä¿¡èŠå¤©
4. ç­‰å¾… 30 ç§’
5. åˆ‡æ¢å›åº”ç”¨
6. âœ… **éªŒè¯**:
   - WebSocket è‡ªåŠ¨é‡è¿
   - æ§åˆ¶å°æ˜¾ç¤ºé‡è¿æ—¥å¿—
   - æ¶ˆæ¯æ­£å¸¸æ¥æ”¶

---

## ğŸ“ å¿«é€Ÿå‚è€ƒ

### å¯è§æ€§ç®¡ç†å™¨ API

```javascript
// æ·»åŠ ç›‘å¬å™¨
const unsubscribe = uni.$visibilityManager.addListener('visible', callback, options);

// ç§»é™¤ç›‘å¬å™¨
unsubscribe();

// æ£€æŸ¥å¯è§æ€§
const isVisible = uni.$visibilityManager.isVisible();

// è·å–éšè—æ—¶é•¿
const duration = uni.$visibilityManager.getHiddenDuration();

// æ‰‹åŠ¨è§¦å‘åˆ·æ–°
uni.$visibilityManager.manualRefresh();
```

### ç›‘å¬å™¨ç±»å‹

```javascript
// åªç›‘å¬é¡µé¢å¯è§
uni.$visibilityManager.addListener('visible', callback);

// åªç›‘å¬é¡µé¢éšè—
uni.$visibilityManager.addListener('hidden', callback);

// åŒæ—¶ç›‘å¬å¯è§å’Œéšè—
uni.$visibilityManager.addListener('both', callback);
```

### å…¨å±€äº‹ä»¶

```javascript
// ç›‘å¬åº”ç”¨ä»åå°æ¢å¤ï¼ˆApp.vue è§¦å‘ï¼‰
uni.$on('app_resumed_from_background', (data) => {
  console.log('åå°æ—¶é•¿:', data.hiddenDuration);
  // æ‰§è¡Œæ¢å¤é€»è¾‘
});
```

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: é¡µé¢æ¢å¤åè¿˜æ˜¯ä¸æ›´æ–°

**æ£€æŸ¥**:
```javascript
// 1. æ£€æŸ¥å¯è§æ€§ç®¡ç†å™¨
console.log(uni.$visibilityManager);

// 2. æ£€æŸ¥æ˜¯å¦æœ‰ç›‘å¬å™¨
console.log(uni.$visibilityManager.listeners.length);

// 3. æ£€æŸ¥å®šæ—¶å™¨æ˜¯å¦å­˜åœ¨
console.log(this.periodtimer, this.balancetimer);
```

**è§£å†³**: ç¡®ä¿åœ¨ onShow ä¸­è°ƒç”¨äº† `startAllTimers()`

### é—®é¢˜ 2: WebSocket ä¸é‡è¿

**æ£€æŸ¥**:
```javascript
console.log('è¿æ¥çŠ¶æ€:', uni.$socketUtils.isOpenSocket);
console.log('ç”¨æˆ·å…³é—­:', uni.$socketUtils.isUserClose);
console.log('è‡ªåŠ¨é‡è¿:', uni.$socketUtils.shouldAutoReconnect);
```

**è§£å†³**: ç¡®ä¿ `shouldAutoReconnect` ä¸º true

### é—®é¢˜ 3: å®šæ—¶å™¨é‡å¤è¿è¡Œ

**æ£€æŸ¥**:
```javascript
// æŸ¥çœ‹å®šæ—¶å™¨ ID
console.log('æœŸå·å®šæ—¶å™¨ ID:', this.periodtimer);
console.log('ä½™é¢å®šæ—¶å™¨ ID:', this.balancetimer);
```

**è§£å†³**: åœ¨ `startAllTimers()` å¼€å§‹æ—¶å…ˆè°ƒç”¨ `clearAllTimers()`

### é—®é¢˜ 4: æ§åˆ¶å°æŠ¥é”™

**å¸¸è§é”™è¯¯**:
```javascript
// é”™è¯¯: uni.$visibilityManager is undefined
// åŸå› : main.js æœªæ­£ç¡®åˆå§‹åŒ–
// è§£å†³: æ£€æŸ¥ main.js æ˜¯å¦åŒ…å«åˆå§‹åŒ–ä»£ç 

// é”™è¯¯: this.visibilityUnsubscribe is not a function
// åŸå› : ç›‘å¬å™¨æœªæ­£ç¡®è¿”å›å–æ¶ˆå‡½æ•°
// è§£å†³: æ£€æŸ¥ addListener æ˜¯å¦æ­£ç¡®è°ƒç”¨
```

---

## ğŸ“¦ æ–‡ä»¶æ¸…å•

### æ ¸å¿ƒæ–‡ä»¶ï¼ˆå¿…éœ€ï¼‰

- âœ… `/common/visibilityManager.js` - å¯è§æ€§ç®¡ç†å™¨
- âœ… `/main.js` - å·²ä¿®æ”¹ï¼Œåˆå§‹åŒ–ç®¡ç†å™¨
- âœ… `/App.vue` - å·²ä¿®æ”¹ï¼Œå…¨å±€æ¢å¤å¤„ç†
- âœ… `/common/websocketUtils.js` - å·²ä¿®æ”¹ï¼Œå¢å¼ºé‡è¿

### æ–‡æ¡£æ–‡ä»¶ï¼ˆå‚è€ƒï¼‰

- ğŸ“„ `/å¾®ä¿¡å†…ç½®æµè§ˆå™¨åå°æ¢å¤é—®é¢˜ä¿®å¤æ–¹æ¡ˆ.md` - å®Œæ•´æ–‡æ¡£
- ğŸ“„ `/å¾®ä¿¡åå°æ¢å¤é—®é¢˜-ä¿®å¤æ€»ç»“æŠ¥å‘Š.md` - æ€»ç»“æŠ¥å‘Š
- ğŸ“„ `/copage/chat-visibility-fix-example.js` - ä»£ç ç¤ºä¾‹
- ğŸ“„ `/QUICK_START.md` - æœ¬æ–‡ä»¶

### æµ‹è¯•æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰

- ğŸ§ª `/æµ‹è¯•é¡µé¢å¯è§æ€§ä¿®å¤.html` - ç‹¬ç«‹æµ‹è¯•é¡µ

---

## âš™ï¸ ç¼–è¯‘å’Œéƒ¨ç½²

### å¼€å‘ç¯å¢ƒæµ‹è¯•

```bash
cd /www/wwwroot/chsgappV2
npm run dev
```

æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼Œåº”è¯¥çœ‹åˆ°ï¼š
```
ğŸ“± é¡µé¢å¯è§æ€§ç®¡ç†å™¨å·²åˆå§‹åŒ–
âœ… H5 é¡µé¢å¯è§æ€§ç›‘å¬å™¨å·²æ³¨å†Œ
```

### ç”Ÿäº§ç¯å¢ƒæ„å»º

```bash
cd /www/wwwroot/chsgappV2
npm run build
```

æ„å»ºäº§ç‰©åœ¨ `dist/` ç›®å½•

### éƒ¨ç½²åˆ°æœåŠ¡å™¨

```bash
# å¦‚æœå·²ç»åœ¨æœåŠ¡å™¨ä¸Šï¼Œé‡å¯åº”ç”¨
# å¦‚æœä½¿ç”¨ HBuilderX æ„å»ºï¼Œç›´æ¥ä¸Šä¼ å³å¯
```

---

## âœ… éªŒæ”¶æ ‡å‡†

- [ ] æµ‹è¯•é¡µé¢è®¡æ—¶å™¨èƒ½æ­£å¸¸æ¢å¤
- [ ] èŠå¤©å®¤å€’è®¡æ—¶èƒ½æ­£å¸¸æ¢å¤
- [ ] ä½™é¢èƒ½å®æ—¶æ›´æ–°
- [ ] WebSocket èƒ½è‡ªåŠ¨é‡è¿
- [ ] å¿«é€Ÿåˆ‡æ¢ 10 æ¬¡æ— å¼‚å¸¸
- [ ] æ§åˆ¶å°æ— é”™è¯¯æ—¥å¿—
- [ ] å†…å­˜å ç”¨æ­£å¸¸

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

### æŸ¥çœ‹è¯¦ç»†æ–‡æ¡£
```bash
cat /www/wwwroot/chsgappV2/å¾®ä¿¡å†…ç½®æµè§ˆå™¨åå°æ¢å¤é—®é¢˜ä¿®å¤æ–¹æ¡ˆ.md
```

### æŸ¥çœ‹ä»£ç ç¤ºä¾‹
```bash
cat /www/wwwroot/chsgappV2/copage/chat-visibility-fix-example.js
```

### æŸ¥çœ‹æ€»ç»“æŠ¥å‘Š
```bash
cat /www/wwwroot/chsgappV2/å¾®ä¿¡åå°æ¢å¤é—®é¢˜-ä¿®å¤æ€»ç»“æŠ¥å‘Š.md
```

---

**æœ€åæ›´æ–°**: 2025-11-04  
**ç‰ˆæœ¬**: 1.0.0  
**çŠ¶æ€**: âœ… å¯ä»¥ä½¿ç”¨

